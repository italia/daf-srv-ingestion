{
  "name": "invalids-initialization",
  "description": "initializations steps to handle invalids records",
  "version": 1,
  "tasks": [

    {
      "name": "sub_workflow_task",
      "taskReferenceName": "sub1",
      "inputParameters": {
        "feedInput": "${workflow.input.feedInput}"
      },
      "type": "SUB_WORKFLOW",
      "subWorkflowParam": {
        "name": "check-folder",
        "version": 1
      }
    },

    {
      "name": "decide_task",
      "taskReferenceName": "decide1",
      "inputParameters": {
        "case_value_param1": "${sub1.check-invalids-folder.FileStatus.type}",
        "case_value_param2": "${workflow.input.init.check-invalids-folder}"
      },
      "type": "DECISION",
      "caseExpression": "$.case_value_param1==='DIRECTORY' && $.case_value_param2 ==='DIRECTORY' ? 'OK' : 'KO'",
      "decisionCases": {
        "OK": [
          {
            "name": "call-service",
            "taskReferenceName": "set-permission-on-invalids-folder",
            "inputParameters": {
              "http_request": {
                "uri": "${workflow.input.feedInput.env.sec-man-url}/hdfs/setACL${workflow.input.feedInput.datasetPath}${workflow.input.feedInput.datasetName}_invalids?groupName=impala&groupType=user&permission=rwx",
                "method": "PUT",
                "body": {},
                "headers":{
                  "Authorization": "${workflow.input.feedInput.authHeader.authType} ${workflow.input.feedInput.authHeader.token}"
                }
              }
            },
            "type": "HTTP"
          }

        ]
      }
    },

    {
      "name": "decide_task",
      "taskReferenceName": "decide2",
      "inputParameters": {
        "case_value_param1": "${sub1.check-invalids-firstStage-folder.FileStatus.type}",
        "case_value_param2": "${workflow.input.init.check-invalids-firstStage-folder}"
      },
      "type": "DECISION",
      "caseExpression": "$.case_value_param1==='DIRECTORY' && $.case_value_param2==='DIRECTORY' ? 'OK' : 'KO'",
      "decisionCases": {
        "OK": [

          {
            "name": "call-service",
            "taskReferenceName": "create-table-on-file",
            "inputParameters": {
              "http_request": {
                "uri": "${workflow.input.feedInput.env.sec-man-url}/impala/createTableFromFile${workflow.input.feedInput.datasetPath}${workflow.input.feedInput.datasetName}_invalids/firstStageParquet?schemaName=${workflow.input.feedInput.dbName}&tableName=${workflow.input.feedInput.tableName}_invalids_1s",
                "method": "PUT",
                "body": {},
                "headers":{
                  "Authorization": "${workflow.input.feedInput.authHeader.authType} ${workflow.input.feedInput.authHeader.token}"
                }
              }
            },
            "type": "HTTP"
          },

          {
            "name": "call-service",
            "taskReferenceName": "create-grant",
            "inputParameters": {
              "http_request": {
                "uri": "${workflow.input.feedInput.env.sec-man-url}/impala/createGrant?schemaName=${workflow.input.feedInput.dbName}&tableName=${workflow.input.feedInput.tableName}_invalids_1s",
                "method": "PUT",
                "body": {},
                "headers":{
                  "Authorization": "${workflow.input.feedInput.authHeader.authType} ${workflow.input.feedInput.authHeader.token}"
                }
              }
            },
            "type": "HTTP"
          }

        ]
      }
    },

    {
      "name": "decide_task",
      "taskReferenceName": "decide3",
      "inputParameters": {
        "case_value_param1": "${sub1.check-invalids-secondStage-folder.FileStatus.type}",
        "case_value_param2": "${workflow.input.init.check-invalids-secondStage-folder}"
      },
      "type": "DECISION",
      "caseExpression": "$.case_value_param1==='DIRECTORY' && $.case_value_param2==='DIRECTORY' ? 'OK' : 'KO'",
      "decisionCases": {
        "OK": [

          {
            "name": "call-service",
            "taskReferenceName": "create-table-on-file",
            "inputParameters": {
              "http_request": {
                "uri": "${workflow.input.feedInput.env.sec-man-url}/impala/createTableFromFile${workflow.input.feedInput.datasetPath}${workflow.input.feedInput.datasetName}_invalids/secondStageParquet?schemaName=${workflow.input.feedInput.dbName}&tableName=${workflow.input.feedInput.tableName}_invalids_2s",
                "method": "PUT",
                "body": {},
                "headers":{
                  "Authorization": "${workflow.input.feedInput.authHeader.authType} ${workflow.input.feedInput.authHeader.token}"
                }
              }
            },
            "type": "HTTP"
          },

          {
            "name": "call-service",
            "taskReferenceName": "create-grant",
            "inputParameters": {
              "http_request": {
                "uri": "${workflow.input.feedInput.env.sec-man-url}/impala/createGrant?schemaName=${workflow.input.feedInput.dbName}&tableName=${workflow.input.feedInput.tableName}_invalids_2s",
                "method": "PUT",
                "body": {},
                "headers":{
                  "Authorization": "${workflow.input.feedInput.authHeader.authType} ${workflow.input.feedInput.authHeader.token}"
                }
              }
            },
            "type": "HTTP"
          }

        ]
      }
    }


  ],
  "outputParameters": {
    "folder": "${check-invalids-folder.FileStatus.type}"
  },
  "schemaVersion": 2
}